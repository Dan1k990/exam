    // Переключение темы
    function toggleTheme() {
        document.body.classList.toggle('dark');
        localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
        updateChapterModalTheme();
    }

    // Проверка сохранённой темы при загрузке
    document.addEventListener('DOMContentLoaded', function() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark' || savedTheme === null) {
            document.body.classList.add('dark');
        } else {
            document.body.classList.add('light');
        }
    });

    // Функция для фильтрации по тегам, автору, году
    function filterBy(type, value) {
        const params = new URLSearchParams();
        params.set(type, value);
        window.location.href = `../bookreader_catalog.html?${params.toString()}`;
    }

    // Обновление темы модального окна
    function updateChapterModalTheme() {
        const modal = document.querySelector('.chapter-modal');
        if (modal) {
            if (document.body.classList.contains('dark')) {
                modal.classList.remove('light');
            } else {
                modal.classList.add('light');
            }
        }
    }

    // Функция для открытия главы
    function readChapter(chapterId) {
        // Создаём модальное окно
        const modal = document.createElement('div');
        modal.className = 'chapter-modal';
        
        // Устанавливаем тему в соответствии с основной темой
        if (!document.body.classList.contains('dark')) {
            modal.classList.add('light');
        }
        
        // Заголовок и текст главы
        let chapterTitle = '';
        let chapterText = '';
        
        switch(chapterId) {
            case 'chapter1':
                chapterTitle = 'Глава 1. Никогда не разговаривайте с неизвестными';
                chapterText = `
                    <p>В жаркий весенний закат на Патриарших прудах появляются двое литераторов и загадочный иностранец.</p>
                    <p>Один из них — поэт Иван Бездомный, другой — редактор толстого литературного журнала Михаил Александрович Берлиоз. Одеты они были по-весеннему легко, но при этом заметно, что жара всё же действовала на них обессиливающе. Они сели на лавку у воды и пытались привести мысли в порядок. Время близилось к семи вечера, и над Москвой стелился густой, душный воздух. Кроны деревьев почти не колыхались, лишь изредка налетал слабый ветерок.
— Вы понимаете, Иван, — заговорил Берлиоз, сняв шляпу и вытирая платком лоб, — ведь ваш образ Христа в поэме получился, как бы это сказать, неубедительным. Он получился каким-то... живописным. Надо бы больше логики, критического подхода. И, главное, — голос его стал наставительным, — Христа ведь не существовало.
Бездомный нахмурился. Он был молод, горяч, и его переполняло вдохновение. Он считал, что поэма получилась исключительно мощной. Впрочем, спорить с редактором он не стал, лишь недовольно покрутил сигарету в пальцах.
— Допустим, — сказал он осторожно. — Но разве не важно то, как я его изобразил? Мы же стремимся показать, насколько ложны эти религиозные выдумки. Я хотел, чтобы читатель прочувствовал фальшь всей этой истории.
Берлиоз покачал головой.
— Нет, нет, дорогой мой, фальшь должна быть очевидной, не эмоциональной, а рациональной. Вы же сами знаете: чем больше логики, тем меньше веры. Это закон. Не зря же мы сотрудничаем с антирелигиозным издательством.
И тут произошло нечто странное.
Позади них послышались шаги, и к лавочке подошёл человек. Он был среднего роста, худощав, одет в дорогой серый костюм, с застёгнутым на все пуговицы пиджаком, на голове — модная серая шляпа. Но больше всего привлекали внимание глаза — один зелёный, другой чёрный. Глаза были полны иронии и одновременно какой-то невыразимой тоски.
— Прошу прощения, господа, — сказал он на удивление чистым русским языком с лёгким иностранным акцентом. — Не могли бы вы позволить мне присесть? Уж больно вечер хорош.
Берлиоз и Бездомный переглянулись. Михаил Александрович, как человек вежливый и воспитанный, жестом указал на свободное место на лавке. Незнакомец сел, сложил руки на трости с чёрной головкой в виде головы пса и, пристально глядя на обоих, сказал:
— Я, между прочим, профессор. Профессор чёрной магии. Недавно прибыл из-за границы. И вот, вы знаете, сижу в вашем замечательном городе и слушаю ваш чудесный разговор.
Берлиоз насторожился, а Бездомный распахнул глаза.
— Вы подслушивали? — резко спросил он.
— Что вы, что вы! — отмахнулся иностранец. — Просто вы говорили довольно громко. К тому же, тема меня интересует. Вы вот, к примеру, утверждаете, что Иешуа Га-Ноцри, он же Иисус, никогда не существовал?
— Именно так, — сухо ответил Берлиоз. — Мы стоим на позициях научного атеизма.
— Ах, как интересно! — воскликнул незнакомец. — Простите моё любопытство, но кто же тогда, по-вашему, беседовал с прокуратором Иудеи Понтием Пилатом ранним утром на балконе дворца?
На лицах литераторов отразилось замешательство. Бездомный нахмурился, Берлиоз приподнял брови.
— Простите, но вы уверены, что были свидетелем этого? — осторожно спросил Михаил Александрович.
Незнакомец усмехнулся, его глаза сверкнули.
— Милейший! Да я же лично был там. Сидел, если угодно, за колонной и слушал. И скажу вам больше — разговор был весьма любопытен. Пилат был болен мигренью, а Иешуа оказался человеком удивительно добрым.
Бездомный усмехнулся.
— Вы что, писатель? Или мистификатор?
— Ничуть. Я историк. Хотя... — он подмигнул. — Бывает, что и магию практикую. Вот вы, к примеру, верите в дьявола?
— Разумеется, нет, — резко ответил Берлиоз.
— Как жаль, — вздохнул незнакомец. — Ведь он существует.
Он поднял палец, словно хотел произнести ещё что-то, но замер. Вдруг налетел ветер, кружанул пыль, и Берлиоз почувствовал, что земля словно уходит из-под ног. Всё завертелось. Он встал, пошатнулся и побледнел.
— Простите... голова... — пробормотал он и, шатаясь, направился к выходу из сквера.
— Он погибнет, — вдруг сказал незнакомец с каким-то мрачным удовлетворением. — Его голова будет отрезана.
Бездомный побледнел.
— Что вы несёте?! Кто вы такой?
— Я тот, кто знает. Уверяю вас, через десять минут его уже не будет среди живых. А вы... вы будете писать стихи, но никто их не напечатает. Вас ждёт психиатрическая больница.
— Вы с ума сошли! — закричал поэт, вскакивая. — Это угроза!
— Нет, это предсказание, — спокойно сказал иностранец. — А теперь простите, у меня встреча.
Он встал, поклонился и исчез между деревьями. Бездомный остолбенел. Всё происходившее казалось ему сном или галлюцинацией. Но через несколько минут в сквер ворвались люди, и один из них, воскликнув: «Несчастный случай на трамвайных путях!», сообщил, что мужчина, похожий на Берлиоза, упал под колёса и погиб на месте.
Бездомный бросился прочь. Его разум охватил хаос. Он хотел найти того странного человека, того самого, кто предсказал ужасную смерть редактора. Он пробежал через весь парк, заглядывал в лица прохожих, кричал, будто сумасшедший. Но его никто не слушал. Вечер продолжал густеть. Лавочки пустели. Где-то вдали слышалась музыка. Патриаршие пруды снова становились тихим, обыденным уголком Москвы, но теперь в этой тишине витала тревога.
Поэт выбежал на улицу, бросился на проезжую часть, едва не попав под автомобиль, и только поздно ночью, уставший, осыпанный пылью, он оказался в странном здании с зелёным крестом, где дежурный врач сказал, не поднимая головы:
— Да-да, буйный. Поместим. Назовётесь — и под капельницу. Вы — Бездомный? Прекрасно, вас уже ищут.
И только теперь Иван понял: случилось что-то непоправимое. Реальность треснула, и сквозь неё проступила иная сила, древняя, холодная и загадочная, неведомая Москве 30-х годов. И это было лишь начало.</p>
                `;
                break;
            case 'chapter13':
                chapterTitle = 'Глава 13. Явление героя';
                chapterText = `
                    <p>Маргарита читает рукопись Мастера, погружаясь в историю Понтия Пилата.</p>
                    <p>День клонился к вечеру, и над Москвой ложился багровый свет заката, словно вспышка пламени на куполах, окнах и антеннах. В своей комнате, где старинный шкаф скрипел от времени, а подоконник был уставлен фиалками, Маргарита сидела в кресле, прижав к груди пожелтевшие страницы. Это была рукопись. Его рукопись. Он — тот, кого она называла не иначе как Мастер.
Комната словно замерла. Часы перестали тикать. Сквозь открытое окно не доносилось ни звука. Только её дыхание да шелест бумаги, когда она переворачивала страницу за страницей, погружённая в мир, где на фоне римских форумов и безжалостного иудейского солнца шел свой путь человек, осуждённый не по законам, а по прихоти страха и власти.
С каждой страницей перед ней оживал Иешуа, его кроткие глаза, бродячие сандалии, тихий голос, — и Пилат, мрачный, страдающий, проклинающий и себя, и весь прокураторат. Маргарита чувствовала: она не просто читает — она проживает заново его боль, его одиночество, его отчаяние. И среди строк, пробегающих под её пальцами, сквозила душа самого Мастера — человека, отвергнутого, уничтоженного, но не сломленного.
«Меня предали, Маргарита», — вспомнила она его голос, звучавший когда-то ночью, дрожащий и безнадёжный. — «И не только друзья. Меня предала литература. Предали издатели, критики, сама бумага, на которой я писал».
Она закрыла глаза, прижав тетрадь к губам.
— Но я не предала, — прошептала она.
А где-то далеко от этой комнаты, за высокими стенами клиники для душевно больных, в белом халате, с непониманием на лице и осторожностью в каждом движении, Иван Бездомный стоял у окна палаты № 117. Всё здесь было чуждо ему — стены, кровать, зеркала, странная тишина и запах медикаментов. Иван, человек улицы, человек с газетной строкой, теперь оказался среди безмолвных теней, где никто не знал, кто говорит правду, а кто просто бредит.
Иван чувствовал, что сходил с ума. Он пытался объяснить врачу, санитару, любому, кто подходил, что видел дьявола, что говорящий кот ускакал на трамвае, что Берлиоза убили не колёса, а рок. Но никто не верил. Ему предлагали успокоительное, горячий чай и настойчиво советовали отдыхать.
А ночью он впервые заметил, что за тонкой перегородкой, за стеной, что будто дышала, как живое существо, живёт кто-то ещё. Он слышал скрип пера, мягкие шаги, иногда — кашель. И вот в одну ночь, набравшись решимости, он заговорил сквозь дверь:
— Эй... ты... ты кто?
Молчание.
Потом — голос. Тихий, ровный, с каким-то усталым достоинством:
— Я? Я писатель.
— Писатель? — оживился Иван, подходя ближе к перегородке. — Какой же ты писатель, если сидишь здесь?
— А ты? — спокойно ответил голос. — Разве ты не поэт? И тоже здесь.
Иван замолчал. Его поразила эта простая логика.
— Ты что написал?
— Роман.
— О чём?
— О Понтии Пилате.
Иван отшатнулся, словно от удара. Он сел на койку, сжал голову руками.
— Нет... этого не может быть... Это совпадение. Это... тот иностранец, он говорил об этом...
— Ах да, — голос за перегородкой стал задумчивым. — Иностранец. В шляпе и с тростью? С глазами разного цвета?
— Да! — воскликнул Иван. — Ты его знаешь?
— Он разрушил мою жизнь, — просто сказал голос. — Но, возможно, и спас.
Наступила пауза. Ночь за окном сгущалась. Луна пробивалась сквозь стекло. Иван прошептал:
— Как тебя зовут?
— У меня нет имени, — ответил голос. — Я отказался от него. Как ты отказался от поэзии. Я был писателем, а теперь я никто. Просто — Мастер.
Иван долго молчал. Потом прошептал:
— А я — Бездомный.
— Что ж, — усмехнулся Мастер. — Странная компания. Мастер и Бездомный. Почти как в романе.
Так началось их ночное знакомство — без лиц, без жестов, только голосом, только душой. Иван слушал его рассказ — о женщине по имени Маргарита, о рукописи, которую сожгли, о предательстве критиков, о безумии славы и о вечном страхе. И в этих рассказах Иван впервые не чувствовал себя сумасшедшим. Он чувствовал, что нашёл единственного в мире человека, кто действительно понимает его.
— Ты ещё пишешь? — спросил он однажды.
— Нет, — ответил Мастер. — Всё, что я написал, — исчезло. Осталось только в памяти. Но, может быть, где-то она уцелела... в чьём-то сердце.
— А ты веришь в дьявола? — спросил Иван.
— Я верю в Воланда, — с улыбкой произнёс Мастер. — И в то, что всё записано. Всё уже было, и всё ещё будет.
И в тот же час, словно откликаясь на его слова, Маргарита открыла глаза и поняла: он жив. Её Мастер жив. Она чувствовала его дыхание между строк, слышала его голос в каждом слове. Её губы прошептали:
— Я найду тебя. Даже если мир исчезнет — я найду.
И рукопись, как бы испепелённой она ни казалась, снова ожила в её руках — свидетельство любви, безумия и истины. А в клинике Иван прижался к стене, чувствуя рядом невидимое присутствие. Возможно, впервые за долгое время он не боялся.</p>
                `;
                break;
            case 'chapter32':
                chapterTitle = 'Глава 32. Прощение и вечный приют';
                chapterText = `
                    <p>Воланд и его свита покидают Москву, забирая с собой Мастера и Маргариту.</p>
                    <p>Ночь опустилась над Москвой, как покрывало забвения. Туман, словно дыхание иной реальности, медленно поднимался с крыш, скользил по улицам, вползал в окна и двери, затуманивая грань между сном и явью, между тем, что было, и тем, что только должно случиться. Воланд стоял на вершине холма. Чёрный плащ его развевался, словно крылья великого ночного хищника, а рядом, чуть позади, сидел огромный кот с сардонической ухмылкой, прижимая к себе свою неизменную рюмку.
Позади, в тени, как тени прошлого, стояли Азазелло и Коровьев, молчаливые, готовые исчезнуть по первому жесту.
— Всё свершилось, — негромко произнёс Воланд. — Все получили то, чего желали... или то, что заслужили.
Он глядел вниз — туда, где по каменной лестнице поднимались двое: мужчина с глубокими глазами, в плаще, с лицом измождённым, но уже не страдающим, и женщина, в белом, будто сотканном из лунного света. Она шла рядом, держась за его руку, и ни один шаг не давался ей трудно. В её глазах не было ни страха, ни боли — только покой и предвкушение покоя.
Они остановились перед Воландом.
— Вы пришли, — сказал он, и голос его не был страшным. Он был, скорее, уставшим. — Долгий путь. Даже слишком долгий. И слишком трудный.
Мастер кивнул.
— Мы готовы, — тихо произнесла Маргарита. — Мы прошли через огонь, через тьму и предательство. Мы больше не желаем славы, не ищем света. Мы хотим только покоя. Вместе.
— Покой, — с лёгкой усмешкой повторил Воланд. — Вы не просите света? Ни рая, ни прощения? Ни возвращения в мир, где вас судили, унижали, сжигали ваши страницы?
— Нет, — сказал Мастер. — Мы не ищем награды. Нам достаточно того, что мы снова рядом.
Воланд молча протянул руку. И в ту же секунду пространство вокруг словно дрогнуло. Исчезли улицы, крыши, звёзды. Погасли фонари. Открылся путь.
Далеко, вдали, под куполом непроглядной тьмы, вспыхнул слабый, но тёплый свет. Он не был слепящим. Это был свет свечи, что горит в окне того, кто ждал. Это был свет дома.
— Вот ваш приют, — сказал Воланд. — Не рай. Рай не для вас. Свет — не для вас. Но не бойтесь. Вас не тронет ни один демон. Вам больше не нужно скрываться, не нужно сжигать рукописи. Вы больше не потеряетесь. Здесь — ваш вечный дом.
Он сделал лёгкое движение рукой, и вокруг зазвучала музыка. Не громкая, не торжественная — просто гармония, простая, как стук сердца. Камни под ногами исчезли, уступая место мягкой тропе. Деревья склонились в поклоне. Воздух наполнился запахом лета и страниц — запахом полей, свободы и чернил.</p>
                `;
                break;
        }
        
        // Добавляем содержимое модального окна
        modal.innerHTML = `
            <div class="chapter-content">
                <h2>${chapterTitle}</h2>
                <div class="chapter-text">
                    ${chapterText}
                </div>
                <button class="close-chapter">
                    Закрыть
                </button>
            </div>
        `;
        
        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden';
        
        // Обработчик закрытия
        modal.querySelector('.close-chapter').addEventListener('click', function() {
            modal.remove();
            document.body.style.overflow = '';
        });
        
        // Закрытие по клику вне контента
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.remove();
                document.body.style.overflow = '';
            }
        });
    }
